<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>JSON Streams Tokenizer Test</title>
	<style>body { background: #333; color: #ccc;  }</style>
</head>
<body>
<h1>JSON Streams Tokenizer Test</h1>
<script type="module">
import { JSONStreamParser } from "../dist/json-stream-parser.esm.js";

const delegate = {
	errorMsg: "",
	value: undefined,
	valueStack: [],
	nextKey: "",

	reset() {
		this.errorMsg = "";
		this.value = undefined;
		this.valueStack = [];
		this.nextKey = undefined;
	},

	key(label) {
		this.nextKey = label;
	},

	addValue(val) {
		if (this.value === undefined) {
			this.value = val;
		}
		else if (Array.isArray(this.value)) {
			this.value.push(val);
		}
		else if (this.nextKey) {
			this.value[this.nextKey] = val;
			this.nextKey = undefined;
		}
	},

	null() {
		this.addValue(null);
	},
	true() {
		this.addValue(true);
	},
	false() {
		this.addValue(false);
	},

	number(value) {
		this.addValue(value);
	},
	string(value) {
		this.addValue(value);
	},

	objectStart() {
		const o = {};
		this.addValue(o);
		if (this.value) {
			this.valueStack.push(this.value);
		}
		this.value = o;
	},
	objectEnd() {
		this.value = this.valueStack.pop();
	},

	arrayStart() {
		const a = [];
		this.addValue(a);
		if (this.value) {
			this.valueStack.push(this.value);
		}
		this.value = a;
	},
	arrayEnd() {
		this.value = this.valueStack.pop();
	},

	error(message) {
		console.warn(message);
		this.errorMsg = message;
	},
};

async function runTest(collection, index, { expectedError, expectedComplete }) {
	delegate.reset();
	const parser = new JSONStreamParser(delegate);
	const text = await fetch(`./jsonchecker/${collection}${index}.json`).then(r => r.text());
	// parser.append(text);
	const chars = text.split("");
	for (const c of chars) {
		if (parser.ok) {
			parser.append(c);
		}
		if (parser.ok) {
			parser.append("");
		}
	}
	console.info(`${collection} ${index}`, parser.ok && parser.completed, delegate.value);
	// if (expectedError && expectedError !== parser.errorMsg) {
	// 	console.error();
	// }
}

async function runAll() {
	for (let x = 1; x <= 33; ++x) {
		await runTest("fail", x, {});
	}

	for (let y = 1; y <= 3; ++y) {
		await runTest("pass", y, {});
	}
}

runAll();

</script>
</body>
</html>
